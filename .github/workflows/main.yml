name: CI

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ifP1/setup-processing@v1.0.2
        with:
          version: 3.5.4
      - name: Building...
        run: processing-java --sketch=$PWD --build
        
  release:
    needs: [test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    env:
      REPO_NAME_PATH: Reaktionszeit
    steps:
      - uses: actions/checkout@v2
      - uses: ifP1/setup-processing@v1.0.2
        with:
          version: 3.5.4
      - name: Get file prefix
        id: get_file
        run: echo ::set-output name=PREFIX::${GITHUB_REPOSITORY/${{ github.repository_owner }}\//}-${GITHUB_REF/refs\/tags\//}
      - name: Exporting windows application...
        run: processing-java --sketch=$PWD --output=out/${{steps.get_file.outputs.PREFIX}}-windows --no-java --platform=windows --export
      - name: Exporting linux application...
        run: processing-java --sketch=$PWD --output=out/${{steps.get_file.outputs.PREFIX}}-linux --no-java --platform=linux --export
      - name: Compressing and Packaging...
        run: |
          cd out
          tar -czvf ../${{steps.get_file.outputs.PREFIX}}-linux.tar.gz ${{steps.get_file.outputs.PREFIX}}-linux/
          zip -r ../${{steps.get_file.outputs.PREFIX}}-windows.zip ${{steps.get_file.outputs.PREFIX}}-windows/
      - name: GitHub Release
        uses: softprops/action-gh-release@v0.1.5
        with:
          files: |
            *-linux.tar.gz
            *-windows.zip
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
