name: CI

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ifP1/setup-processing@v1.0.2
        with:
          version: 3.5.4
      - name: Building...
        run: processing-java --sketch=$PWD --build
        
  build:
    needs: [test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v2
      - uses: ifP1/setup-processing@v1.0.2
        with:
          version: 3.5.4
      - name: Get file prefix
        id: get_file
        run: echo ::set-output name=PREFIX::${GITHUB_REPOSITORY/${{ github.repository_owner }}\//}-${GITHUB_REF/refs\/tags\//}
      - name: Exporting windows application...
        run: processing-java --sketch=$PWD --output=out/${{steps.get_file.outputs.PREFIX}}-windows --no-java --platform=windows --export
      - name: Exporting linux application...
        run: processing-java --sketch=$PWD --output=out/${{steps.get_file.outputs.PREFIX}}-linux --no-java --platform=linux --export
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v2
        with:
          path: out/*

  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2
      - run: ls -lah
      - run: ls -lah artifact
      # - name: Compressing and Packaging...
      #   run: |
      #     cd out
      #     tar -czvf ../${{steps.get_file.outputs.PREFIX}}-linux.tar.gz ${{steps.get_file.outputs.PREFIX}}-linux/
      #     zip -r ../${{steps.get_file.outputs.PREFIX}}-windows.zip ${{steps.get_file.outputs.PREFIX}}-windows/
      # - name: GitHub Release
      #   uses: softprops/action-gh-release@v0.1.5
      #   with:
      #     files: |
      #       *-linux*
      #       *-windows*
      #   env:
      #     GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  # deploy:
  #   needs: [build]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: FTP Deploy
  #       uses: SamKirkland/FTP-Deploy-Action@3.0.0
  #       with:
  #         # Deployment destination server & path. Formatted as protocol://domain.com:port/full/destination/path/
  #         ftp-server: ftpes://gymnasium-melle.org:21/group/abi21.ifp1/Files/Java/Target
  #         # FTP account username
  #         ftp-username: quang.thanh.ta
  #         # FTP account password
  #         ftp-password: ${{secrets.FTP_PASSWORD}}
  #         # The local folder to copy, defaults to root project folder
  #         local-dir: # optional